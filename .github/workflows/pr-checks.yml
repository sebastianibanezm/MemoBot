# Phase 9: PR checks â€” lint, type-check, build, test (PLAN.md).
# Required GitHub secrets for test step (use test/mock values):
#   NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY, CLERK_SECRET_KEY,
#   NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY,
#   OPENAI_API_KEY, ANTHROPIC_API_KEY, TELEGRAM_WEBHOOK_SECRET,
#   WHATSAPP_VERIFY_TOKEN, WHATSAPP_APP_SECRET

name: PR Checks

on:
  pull_request:
    branches: [main, develop]

jobs:
  lint-typecheck-build-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: Lint
        run: npm run lint

      - name: Create .env.local for build and test
        run: |
          {
            echo "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${CLERK_PK:-pk_test_ci}"
            echo "CLERK_SECRET_KEY=${CLERK_SK:-sk_test_ci}"
            echo "NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL:-https://ci.supabase.co}"
            echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON:-eyJhbGciOiJIUzI1NiJ9.ci}"
            echo "SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE:-eyJhbGciOiJIUzI1NiJ9.ci}"
            echo "OPENAI_API_KEY=${OPENAI_API_KEY:-sk-ci}"
            echo "ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-sk-ant-ci}"
            echo "TELEGRAM_WEBHOOK_SECRET=${TELEGRAM_WEBHOOK_SECRET:-tg-ci}"
            echo "WHATSAPP_VERIFY_TOKEN=${WHATSAPP_VERIFY_TOKEN:-wa-verify-ci}"
            echo "WHATSAPP_APP_SECRET=${WHATSAPP_APP_SECRET:-wa-secret-ci}"
          } > .env.local
        env:
          CLERK_PK: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SK: ${{ secrets.CLERK_SECRET_KEY }}
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_ANON: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TELEGRAM_WEBHOOK_SECRET: ${{ secrets.TELEGRAM_WEBHOOK_SECRET }}
          WHATSAPP_VERIFY_TOKEN: ${{ secrets.WHATSAPP_VERIFY_TOKEN }}
          WHATSAPP_APP_SECRET: ${{ secrets.WHATSAPP_APP_SECRET }}

      - name: Build
        run: npm run build

      - name: Test
        run: npm run test
